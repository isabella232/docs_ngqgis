.. sectionauthor:: Артём Светлов <artem.svetlov@nextgis.ru>

.. _raster_ref:
    
Привязка растров
===================

С помощью данного модуля расширения пользователь QGIS получает возможность привязывать растры к координатам.

Для начала работу нужно включить модуль "Привязка растров (GDAL)" в списке модулей. 

После установки модуля появится пункт меню Растр --> Привязка растров.

Этот плагин предоставляет графический интерфейс, в котором пользователь указывает общие опорные точки (традиционно называются gcp, ground control points) на растре и на карте в основном окне NextGIS QGIS. Так же координаты опорных точек можно вводить цифрами с клавиатуры, если на карте есть координатная сетка, и пользователь представляет её код EPSG. Затем при расчёте генерируется новый файл в формате GeoTIFF, с информацией о привязке внутри. 

Примеры операций, которые можно сделать в этом модуле
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

* Привязать советскую топокарту к слою openstreetmap
* Привязать топокарту с сеткой, введя её координаты с клавиатуры, это будет более точно, чем привязывать по точкам.
* Привязать 1-2 снимка поверхности с летательного аппарата по визуальным ориентирам.
* Допривязать полученный из другого софта ортофотоплан к точной карте. 
* Привязать сфотографированную распечатку карты OSM с отметками ручкой, что бы потом оцифровать эти отметки.
* Привязать древнюю карту из книги царских времён у которой нет сетки, или она в неизвестной системе координат.

Порядок действий для привязки карты
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

1. Достать растровый файл с картой, которую вы будете привязывать. Если она в формате .gif, то сконвертируйте её в jpeg или png используя инструмент Растр --> Преобразование --> Преобразовать формат (см http://docs.nextgis.ru/docs_ngqgis/source/raster_op.html#id9) или любой графический редактор.
2. Решить к какой карте вы будете её привязывать, и открыть её в QGIS. 
3. Решить в какой системе координат нужна конечная карта, и проверить что бы в основном окне QGIS было включено перепроцирование на лету в неё. Её нужно указать на шаге 9.
4. Запустить модуль привязки растров: Растр --> Привязка растров. Далее описываются комманды модуля Привязка Растров.
5. Нажать Файл --> Открыть растр. Открываете вашу картинку. На экране появится диалог выбора системы координат, в нём нужно нажать "Отмена".
6. Если исходный файл большой, то он долго будет рисоваться на экране. В этом случае нажмите "Параметры --> Свойства растра --> Пирамиды", выделите там в списке все строки, "тип - внешние", и нажмите "Создать пирамиды". Получится отдельный файлик с уменьшенными копиями растра, который будет использоваться автоматически для более быстрой отрисовки. 
7. Начинается добавление точек. Правка --> Добавить точку. Поставьте точку на карту. Появится окно с панелями ввода и кнопкой "С карты", нажмите "С карты". Откроется основное окно QGIS, поставьте точку на это же место на карту. Поставьте так для начала 3 точки. Минимально необходимое количество точек зависит от алгоритма, если их будет недостаточно, то вам выведется сообщение.
8. Точки можно сохранить на диск, на случай сбоев, коммандой "Файл --> Сохранить контрольные точки как". Сохраните их в путь по умолчанию, и они будут подтягиваться автоматически при следующем запуске модуля Привязки растров. 
9. После ввода точек зайдтие в "Параметры --> Параметры трансформации". Укажите там путь для нового файла, тип трансформации и метод интерполяции, ту систему координат, которую вы выбрали на шаге 3. Объяснение параметров приведено ниже.
10. Закройте окно Параметры трансформации, затем нажмите "Файл --> Начать привязку растра"
11. В основном окне QGIS появится растр. Вы можете проанализировать его невязки визуально, покрутив настройки прозрачности (например для сравнения ортофотопланов и спутниковых снимков подходит режим смешивания "Направленный свет"


Здесь был описан процесс привязки карт по точкам. Так же можно привязвать карты по числовым координатам, см. http://docs.nextgis.ru/docs_howto/source/topo_georef.html

.. info::

   Описание утилиты gdaltransform, которая выполняет расчёты внутри этого модуля: https://www.gdal.org/gdaltransform.html
