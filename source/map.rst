
.. sectionauthor:: Дмитрий Барышников <dmitry.baryshnikov@nextgis.ru>

.. _ngqgis_map:


Создание карты
===============

Добавление геоданных
---------------------

В QGIS реализована возможность работы с проекциями. Проекция может быть установлена как
глобально, т.е. её параметры будут применены к любому векторному слою, не содержащему 
информации о проекции, так и отдельно для проекта. Кроме того, существует возможность 
создания собственных проекций, а также реализована поддержка перепроецирования "на лету" 
для векторных и растровых слоёв. Все эти функции позволяют корректно отображать 
одновременно несколько слоёв, находящихся в различных проекциях.

Все проекции в QGIS основаны на базе идентификаторов European Petroleum Group (ESPG) и
Institut Geographique National of France (IGNF) и в значительной степени абстрагированы 
от таблицы spatial_references в PostGIS версии 1.x. EPSG-коды хранятся в базе данных 
и могут быть использованы для определения проекции.

Для корректной работы перепроецирования "на лету" слой должен содержать информацию о 
проекции, в которой хранятся данные, либо она должна быть определена самостоятельно 
на уровне слоя или проекта. Для слоёв PostGIS QGIS использует идентификатор проекции, 
определяемый в момент создания слоя. Для данных, хранящихся в форматах, поддерживаемых OGR, 
информация о проекции должна быть представлена в соответствующем файле, структура 
которого определяется форматом. В случае shape-файлов - это файл, содержащий описание 
проекции в формате Well Known Text (WKT) и имеющий то же имя, что и shape-файл, 
но с расширением *.prj. Например, для файла alaska.shp файлом описания проекции будет alaska.prj.

Всякий раз, когда происходит выбор новой проекции, используемые единицы слоя автоматически
изменяются, что можно увидеть, перейдя во вкладку Общие диалогового окна - Свойства проекта,
открываемого по нажатию кнопки Редактировать (Gnome, OS X) или Настройки (KDE, Windows)

Установка проекции
-------------------

QGIS создаёт новые проекты с использованием системы координат по умолчанию. Изначально 
используется система координат EPSG:4326 - WGS 8. Это значение можно изменить, нажав 
кнопку "Выбрать" в первой группе настроек во вкладке "Система координат" (см. рисунок
:numref:`ngmobile_coordinate_systemc_configuration_pic`). 
Указанное значение будет использоваться по всех  последующих сеансах работы.

Окно Параментры сети представлено на рисунке см. :numref:`ngmobile_coordinate_systemc_configuration_pic`:

.. figure:: _static/coordinate_systemc_configuration.png
   :name: ngmobile_coordinate_systemc_configuration_pic
   :align: center
   :height: 10cm
   
   Настройки системы координат. 

При загрузке в проект слоёв, не содержащих информации о проекции, необходимо иметь 
возможность контролировать и определять проекции таких слоёв. Проекции могут быть 
установлены глобально или на уровне проекта. Для выполнения этой операции перейдите 
во вкладку "Система координат окна", открываемого через Редактирование - Параметры (Gnome, OS X) 
или Установки - Параметры (KDE, Windows).

На рисунке :numref:`ngmobile_coordinate_systemc_configuration_pic` показаны 
возможные варианты:

1. Запрашивать систему координат.
2. Использовать систему координат проекта.
3. Использовать указанную систему координат.

Если необходимо задать проекцию для слоя, в котором информация о ней отсутствует, 
то это можно сделать во вкладке Общие окна свойств растрового (см. Общие) или 
векторного (см. Общие) слоя. Если слой уже содержит информацию о проекции, то вкладка 
будет выглядеть как показано на рисунке Vector Layer Properties Dialog (рис.11.6).
 
Контекстное меню слоя содержит два элемента для работы с системой координат. 
Пункт меню Изменить систему координат вызывает диалог Выбор системы координат 
(см. рисунок :numref:`ngmobile_coordinate_systemc_configuration_pic`). 
А пункт Выбрать систему координат слоя для проекта устанавливает систему координат 
проекта равной системе координат слоя.

QGIS поддерживает перепроецирование растровых и векторных слоёв "на лету", но по 
умолчанию эта возможность отключена. Для её активации необходимо установить флажок 
"Включить преобразование координат "на лету" на вкладке "Система координат" диалогового 
окна "Свойства проекта".
 
Существует три способа доступа к указанной вкладке:

1. Выберите пункт "Свойства проекта" в меню Редактирование (Gnome, OS X) или Установки
(KDE, Windows).

2. Нажмите кнопку "Преобразование координат", расположенную в правом нижнем углу строки
состояния.

3. Включить преобразование координат "на лету" по умолчанию на вкладке "Система координат"
диалога Параметры активировав флажок "Включить преобразование координат "на лету".

Если имеется загруженный в проект слой и вы желаете включить перепроецирование "на лету", 
то откройте вкладку Система координат диалогового окна Свойства проекта, выберите 
проекцию и отметьте пункт Включить преобразование координат "на лету" (см. рисунок
:numref:`ngmobile_reprojection_on_the_fly_pic`). Значок  Преобразование 
координат станет активным и все последующие загружаемые слои будут  автоматически 
перепроецироваться в выбранную проекцию.

.. figure:: _static/reprojection_on_the_fly.png
   :name: ngmobile_reprojection_on_the_fly_pic
   :align: center
   :height: 10cm

   Перепроецирование "на лету". 

Вкладка Система координат диалогового окна Свойства проекта содержит пять важных 
компонентов, показанных на рисунке :numref:`ngmobile_reprojection_on_the_fly_pic` 
и описанных ниже.

1. Включить преобразование координат "на лету" - данный пункт используется для включения 
или отключения преобразования координат "на лету". Если он отключен, то каждый слой 
отрисовывается в соответствии с проекцией, указанной в источнике данных и элементы,
описанные ниже, будут неактивными. Если включен, то координаты слоя перепроецируются
в проекцию карты.

2. Система координат - список проекций, поддерживаемых QGIS, включая географические,
прямоугольные и пользовательские. Для выбора проекции выделите её имя в списке, 
предварительно развернув нужный узел. Текущая проекция выделена цветом.

3. Proj4 - текстовое представление проекции в формате PROJ.4. Данный текст доступен 
только для чтения и используется в качестве справочной информации.

4. Поиск - если вам известен EPSG-код, идентификатор или имя проекции, то можно 
воспользоваться поиском. Введите идентификатор и нажмите кнопку Найти. Отметьте
Скрыть устаревшие системы координат, чтобы показывать только используемые в настоящее 
время проекции.

5. Недавно использованные системы координат - если имеются определённые наиболее 
часто используемые в проектах проекции, то они будут доступны в таблице, расположенной 
в верхней части диалога Выбор системы координат. Нажмите на одну из строк, чтобы 
выбрать эту систему координат.

Если открыть Свойства проекта из меню Редактирование (Gnome, OS X) или Установки 
(KDE, Windows), то для доступа к настройкам проекций нужно перейти во вкладку Система 
координат. Если же воспользоваться кнопкой Преобразование координат, то вкладка 
Система координат откроется автоматически.

Если вы не нашли нужной проекции, то можно определить собственную. Для этого выберите 
пункт Ввод системы координат меню Редактирование (Gnome, OS X) или Установки (KDE, Windows).
Пользовательские проекции хранятся в пользовательской базе данных. Помимо собственных 
проекций эта база содержит пространственные закладки и прочую информацию.

Для создания собственной проекции необходимо хорошо разбираться в синтаксисе библиотеки 
поддержки картографических проекций PROJ.4. Рекомендуется ознакомиться с документом 
"Cartographic Projection Procedures for the UNIX Environment - A User’s Manual"
(Gerald I. Evenden, U.S. Geological Survey Open-File Report 90-284, 1990), доступным 
по адресу ftp://ftp.remotesensing.org/proj/OF90-284.pdf.
Данное руководство описывает использование proj.4 и связанных утилит командной строки. 
Картографичские параметры, используемые в proj.4, описаны в руководстве и совпадают 
с используемыми в QGIS.
В диалоговом окне Определение пользовательской системы координат требуется всего 
два параметра для определения собственной проекции:

1. Имя проекции.

2. Картографические параметры в формате PROJ.4.

Для создания новой системы координат нажмите кнопку Новая, укажите имя и введите 
необходимые параметры. После чего созданную проекцию можно сохранить нажав кнопку
Сохранить.
Значение поля Параметры создаваемой проекции должно начинаться со строки +proj=.
Создаваемую проекцию можно проверить. Для этого вставьте параметры создаваемой 
проекции в поле Параметры раздела Проверка. Затем введите значения широты и долготы 
WGS-84 в поля Север и Восток соответственно. Нажмите кнопку Рассчитать и сравните 
результат с известными значениями вашей проекции :numref:`ngmobile_user_coordinate_system_pic`).

.. figure:: _static/user_coordinate_system.png
   :name: ngmobile_user_coordinate_system_pic
   :align: center
   :height: 10cm

   Пользовательская система координат.

Настройка стилей
-----------------



Компоновщик карты
------------------



Проекции
====================

В кугисе есть возможность работы с проекциями. У каждого слоя данных есть своя система координат (в которой храняться данные), как правило она записана в самом файле. Почти всегда в кугисе используется функция "преобразования координат на лету": слои хранятся в разных системах координат, а на экран они выводятся в одной. 

Систем координат очень много, однако для работы одновременно используется всего 2-4 штуки, их можно запомнить. 

* WGS 84 (EPSG:4326) - в ней обычно хранятся векторные данные. Единица измерения - градусы. Новые векторные файлы сохраняйте в ней. Если вывести данные из неё без перепроецирования, то картинка будет сплющенной.
* Pseudo Mercator (EPSG:3857) - используется для отображения. Включайте "перепроецирование на лету" в 3857, и карта будет отображаться более правильно.
* WGS 84 / UTM Zone ... (EPSG:12345.. и соседние) - используется для измерения расстояний. Данные хранятся в метрах. Некоторые инструменты требуют её для корректной работы. Так же в ней могут храниться космоснимки. Земной шар разделён на 30 зон, для каждой определена своя проекция - свой код EPSG. Определите зону в которой вы работаете по разграфкам на гис-лабе.
* Pulkovo 1942 / Gauss-Kruger zone ... (EPSG:12345.. и соседние) - устроена так же как UTM, в ней хранятся привязанные листы советских топокарт (изданных в последние годы). Так же разделена на зоны, но с другими номерами. 

.. fixme:
   дописать коды EPSG, возможно сверстать в таблицу

Интерфейс окна выбора системы координат
---------------------------------------------------------------------

QGIS поддерживает перепроецирование растровых и векторных слоёв "на лету", но по умолчанию
эта возможность отключена. Для её активации необходимо установить флажок "Включить 
преобразование координат "на лету" на вкладке "Система координат" диалогового окна 
"Свойства проекта". 
Существует три способа доступа к указанной вкладке:

1. Выберите пункт "Свойства проекта" в меню Редактирование (Gnome, OS X) или Установки
(KDE, Windows).

2. Нажмите кнопку "Преобразование координат", расположенную в правом нижнем углу строки
состояния.

.. figure:: /_static/MapOTF.png
   :align: center
   :width: 35em



.. tip::
   Так же можно его включить по умолчанию: :menuselection:`Параметры --> Система координат --> Система координат для новых проектов` 

.. fixme::
   Переформулировать, очень длинные названия, не понимаю.

.. figure:: /_static/MapProjections.png
   :align: center
   :width: 35em

    Диалог выбора системы координат.

    В этом диалоге имеется 2 списка: сверху - последние выбранные записи, снизу - полный список записей. В строке поиска вы можете вводить нормер EPSG или часть названия. Выбирать систему координат можно из любого списка. 


Основные операции с проекциями, которые нужно знать для работы:
---------------------------------------------------------------------


Как узнать систему координат слоя
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

:menuselection:`Слой --> Свойства --> Вкладка :guilabel:`Общие` --> Система координат`. Это значение можно менять. Систему координат сохранёную в слое можно узнать  :menuselection:`Слой --> Свойства --> Вкладка :guilabel:`Метаданные` --> строка "Система координат слоя"`.

Открытие окна преобразования координат
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

В правом-нижнем углу карты нажмите вторую справа кнопку. Если на ней написано OTF - значит преобразование на лету включёно.

Если картинка на карте сплющена по вертикали.
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Если вы добавили геоданные на карту, и картинка сплющенная - то включите "Преобразование коодинат на лету" в EPSG:3857. Это значит что ваши геоданные были в градусах.


Если данные из разных слоёв не попадают друг на друга, хотя они в одном месте.
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Включите "Преобразование коодинат на лету".

Пересохранение слоёв в другую систему координат
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Для некоторых операций в инструкции потребуется пересохранить слои в другую систему координат. В этом случае выберите :menuselection:`Слой --> Сохранить как`, и выберите систему координат в диалоге сохранения. 




Добавление геоданных
====================

NextGIS QGIS предоставляет пользователю возможность добавлять

* Векторные данные
* Растровые данные
* Подкладывать тайловые подложки из интернета
* Добавлять растры по протоколу WMS и TMS
* Работать по протоколу WFS
* Добавлять слои из веб-гис NextGIS WEB
* Рисовать самому

Добавление растровых и векторных слоёв из файлов
--------------------------------------------------------

Геоданные бывают векторные и растровые. Векторные данные обычно хранятся как электронная таблица, где у каждой записи есть своя геометрия - то есть фигура, заданная координатами точек. Растровые данные обычно хранятся как картинка, в которой указано, на какое место земного шара она ложится.

Существует множество форматов хранения геоданных, и протоколов их передачи по сети. Они могут представлять собой файлы, или находится в базах данных. Преобразованием форматов занимаются утилиты GDAL (растровые) и OGR (векторные). Благодаря этим утилитам NextGIS QGIS может читать и записывать разные форматы данных без сильных различий для пользователя. Разумеется, обычно используются только самые общеупотребительные форматы.

Понятие Слой будет часто встречаться в инструкции. Слой - это то, что видно в списке слоёв, технически это один файл, или одна таблица в БД.


Вам потребуется знать: место где лежат файлы на диске, их кодировку.

Если слой растровый, то скорее всего он будет в формате GeoTIFF (с расширением .tif)
:menuselection:`Слой --> Добавить слой --> Добавить векторный слой` или :menuselection:`Слой --> Добавить слой --> Добавить растровый слой` соответственно.

При открытии ESRI Shapefile в этом диалоге нужно выбирать файл с расширением .shp.

В середине 2010-х годов принято, что все данные сохраняются в кодировке UTF-8. При работе на ОС Windows при открытии и сохранении векторных данных нужно явно указывать кодировку UTF-8. По умолчанию она может быть System - это значит CP1251. Если вы открыли файл в неправильной кодировке, то русские буквы там будут нечитаемыми. В этом случае нужно в свойствах слоя выставить кодировку UTF-8. Но лучше сразу выставлять её при открытии файла, что бы не забыть.

Так же вам необходимо знать кодировку файлов. Если кодировка файлов - UTF-8, то при работе в ОС Windows в поле "Кодировка" рекомендуется выбирать UTF-8, потому что по умолчанию там будет выбрана системная кодировка, и тогда слой откроется в Win-1251.
Если в таблице атрибутов вы увидите крокозябры - переключите кодировку между UTF-8 и Win-1251 в свойствах слоя.



Добавление картоподложки из интернета
--------------------------------------------------------

Осуществляется плагином QuickMapServices

.. fixme::
   Поставить ссылку на.


Работа с базами данных PostGIS
--------------------------------------------------------

Вам потребуется знать URL сервера Postgis, название базы данных, имя пользователя и пароль.


Работа по протоколу WMS
--------------------------------------------------------

Работа по протоколу WFS
--------------------------------------------------------



Добавление картоподложки из интернета
--------------------------------------------------------

Осуществляется плагином QuickMapServices

.. fixme::
   Поставить ссылку на.

Подключение к слоям NGW
--------------------------------------------------------

Осуществляется плагином NGWConnect

.. fixme::
   Поставить ссылку на.

Рисовать самому
========================================================


Настройка стилей
====================

Компоновщик карты
====================

.. `composer_main_properties`:

.. test:
